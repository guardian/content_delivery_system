{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Parameters": {
    "CDSGroupName": {
      "Type": "String",
      "Description": "Name of the CDS group to create. Don't use capital letters, or the deploy will fail on creating S3 buckets."
    },
    "InstanceType": {
      "Type": "String",
      "Description": "AWS instance type for the group. Only choose c3/c4 if you are doing onboard transcoding.  Note that you need m3 or c3 to get instance storage.",
      "Default": "t2.micro",
      "AllowedValues": [
        "t2.micro",
        "t2.medium",
        "m3.medium",
        "m3.large",
        "c3.large",
        "c3.2xlarge",
        "c4.large",
        "c4.2xlarge"
      ]
    },
    "App": {
      "Type": "String",
      "Description": "Name of the app"
    },
    "Stack": {
      "Type": "String",
      "Description": "Name of the stack"
    },
    "Stage": {
      "Type": "String",
      "Description": "Name of the stage",
      "AllowedValues": [
        "CODE",
        "PROD"
      ]
    },
    "KeyName": {
      "Type": "String",
      "Description": "Name of an existing key pair, which will be given root access to the instances"
    },
    "MessageVisibilityTimeout": {
      "Type": "Number",
      "Default": 1800,
      "Description": "Processing timeout, after which a process will be retried. Ensure that this is longer than the expected processing time, or you will get multiple copies of the route running at once"
    },
    "ScaleUpThreshold": {
      "Type": "Number",
      "Default": 5,
      "Description": "Scale up if this number of jobs are waiting"
    }
  },
  "Outputs": {
    "InputBucketName": {
      "Description": "Bucket for incoming media",
      "Value": {
        "Ref": "S3InputBucket"
      }
    },
    "OutputBucketName": {
      "Description": "Bucket for outgoing media",
      "Value": {
        "Ref": "S3OutputBucket"
      }
    },
    "InputQueueName": {
      "Description": "Message queue for test media input",
      "Value": {
        "Ref": "TestInputQueue"
      }
    },
    "OutputTopicName": {
      "Description": "Message queue for test media input",
      "Value": {
        "Ref": "TestOutputTopic"
      }
    }
  },
  "Resources": {
    "ASLC3C5GK": {
      "Type": "AWS::AutoScaling::LaunchConfiguration",
      "Properties": {
        "IamInstanceProfile": {
          "Fn::GetAtt": [
            "CDSInstanceProfile",
            "Arn"
          ]
        },
        "ImageId": "ami-4fbcc83c",
        "InstanceType": {
          "Ref": "InstanceType"
        },
        "KeyName": {
          "Ref": "KeyName"
        },
        "SecurityGroups": [
          "sg-7830ef1f"
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "80182929-8ac7-40b8-b2ba-e3f02cf98bd0"
        }
      }
    },
    "ASASG2FTUE": {
      "Type": "AWS::AutoScaling::AutoScalingGroup",
      "Properties": {
        "AvailabilityZones": [
          "eu-west-1a",
          "eu-west-1b",
          "eu-west-1c"
        ],
        "Cooldown": "300",
        "DesiredCapacity": "1",
        "MaxSize": "4",
        "MinSize": "1",
        "HealthCheckGracePeriod": 300,
        "HealthCheckType": "EC2",
        "LaunchConfigurationName": {
          "Ref": "ASLC3C5GK"
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "CDSGroupName"
                  },
                  " [Autoscaled]"
                ]
              ]
            },
            "PropagateAtLaunch": true
          },
          {
            "Key": "Service",
            "Value": "Content Delivery System (CDS)",
            "PropagateAtLaunch": true
          }
        ],
        "VPCZoneIdentifier": [
          "subnet-d58a938c",
          "subnet-577ca433",
          "subnet-a0d211d6"
        ]
      }
    },
    "IAMR41WUG": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "",
              "Effect": "Allow",
              "Principal": {
                "Service": "ec2.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Policies": [
          {
            "PolicyName": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "CDSGroupName"
                  },
                  "DynamoAccess"
                ]
              ]
            },
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": "*",
                  "Resource": [
                    {
                      "Fn::Join": [
                        "",
                        [
                          "arn:aws:dynamodb:eu-west-1:855023211239:table/",
                          {
                            "Ref": "DBRouteTable"
                          }
                        ]
                      ]
                    },
                    {
                      "Fn::Join": [
                        "",
                        [
                          "arn:aws:dynamodb:eu-west-1:855023211239:table/",
                          {
                            "Ref": "DBResponderTable"
                          }
                        ]
                      ]
                    }
                  ]
                }
              ]
            }
          },
          {
            "PolicyName": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "CDSGroupName"
                  },
                  "S3InputAccess"
                ]
              ]
            },
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "s3:ListBucket",
                    "s3:GetObject"
                  ],
                  "Resource": [
                    {
                      "Fn::Join": [
                        "",
                        [
                          "arn:aws:s3:::",
                          {
                            "Ref": "S3InputBucket"
                          }
                        ]
                      ]
                    },
                    {
                      "Fn::Join": [
                        "",
                        [
                          "arn:aws:s3:::",
                          {
                            "Ref": "S3InputBucket"
                          },
                          "/*"
                        ]
                      ]
                    }
                  ]
                }
              ]
            }
          },
          {
            "PolicyName": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "CDSGroupName"
                  },
                  "S3OutputAccess"
                ]
              ]
            },
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "s3:ListBucket",
                    "s3:GetObject",
                    "s3:PutObject"
                  ],
                  "Resource": [
                    {
                      "Fn::Join": [
                        "",
                        [
                          "arn:aws:s3:::",
                          {
                            "Ref": "S3OutputBucket"
                          }
                        ]
                      ]
                    },
                    {
                      "Fn::Join": [
                        "",
                        [
                          "arn:aws:s3:::",
                          {
                            "Ref": "S3OutputBucket"
                          },
                          "/*"
                        ]
                      ]
                    }
                  ]
                }
              ]
            }
          },
          {
            "PolicyName": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "CDSGroupName"
                  },
                  "InputQueueAccess"
                ]
              ]
            },
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "sqs:*"
                  ],
                  "Resource": [
                    {
                      "Fn::GetAtt": [
                        "TestInputQueue",
                        "Arn"
                      ]
                    }
                  ]
                }
              ]
            }
          },
          {
            "PolicyName": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "CDSGroupName"
                  },
                  "OutputSNSAccess"
                ]
              ]
            },
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "sns:*"
                  ],
                  "Resource": [
                    {
                      "Ref": "TestOutputTopic"
                    }
                  ]
                }
              ]
            }
          }
        ],
        "Path": "/"
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "5e49ff3e-d439-458d-a88d-3d54e458fd26"
        }
      }
    },
    "CDSInstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Path": "/",
        "Roles": [
          {
            "Ref": "IAMR41WUG"
          }
        ]
      }
    },
    "S3InputBucket": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "AccessControl": "BucketOwnerFullControl",
        "BucketName": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "CDSGroupName"
              },
              "-input-bucket"
            ]
          ]
        },
        "LifecycleConfiguration": {
          "Rules": [
            {
              "ExpirationInDays": 5,
              "Status": "Enabled"
            }
          ]
        },
        "Tags": [
          {
            "Key": "UsingService",
            "Value": "CDS"
          },
          {
            "Key": "Warning",
            "Value": "Auto-deleting"
          }
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "2289a7f9-1950-4ee4-9c44-d54a9225aca7"
        }
      }
    },
    "S3OutputBucket": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "AccessControl": "BucketOwnerFullControl",
        "BucketName": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "CDSGroupName"
              },
              "-output-bucket"
            ]
          ]
        },
        "LifecycleConfiguration": {
          "Rules": [
            {
              "ExpirationInDays": 5,
              "Status": "Enabled"
            }
          ]
        },
        "Tags": [
          {
            "Key": "UsingService",
            "Value": "CDS"
          },
          {
            "Key": "Warning",
            "Value": "Auto-deleting"
          }
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "3f662942-9fac-418b-acbe-f6d860fe584d"
        }
      }
    },
    "TestInputQueue": {
      "Type": "AWS::SQS::Queue",
      "Properties": {
        "DelaySeconds": 0,
        "MessageRetentionPeriod": 345600,
        "QueueName": {
          "Fn::Join": [
            "-",
            [
              {
                "Ref": "CDSGroupName"
              },
              "input",
              "test"
            ]
          ]
        },
        "RedrivePolicy": {
          "deadLetterTargetArn": {
            "Fn::GetAtt": [
              "DeadLetter",
              "Arn"
            ]
          },
          "maxReceiveCount": 10
        },
        "VisibilityTimeout": {
          "Ref": "MessageVisibilityTimeout"
        }
      }
    },
    "DeadLetter": {
      "Type": "AWS::SQS::Queue",
      "Properties": {
        "DelaySeconds": 0,
        "MessageRetentionPeriod": 345600,
        "QueueName": {
          "Fn::Join": [
            "-",
            [
              {
                "Ref": "CDSGroupName"
              },
              "deadletter"
            ]
          ]
        },
        "VisibilityTimeout": {
          "Ref": "MessageVisibilityTimeout"
        }
      }
    },
    "TestOutputTopic": {
      "Type": "AWS::SNS::Topic",
      "Properties": {
        "DisplayName": {
          "Fn::Join": [
            "-",
            [
              {
                "Ref": "CDSGroupName"
              },
              "output",
              "test"
            ]
          ]
        }
      }
    },
    "DBRouteTable": {
      "Type": "AWS::DynamoDB::Table",
      "Properties": {
        "TableName": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "CDSGroupName"
              },
              "-cds-routes"
            ]
          ]
        },
        "AttributeDefinitions": [
          {
            "AttributeName": "routename",
            "AttributeType": "S"
          },
          {
            "AttributeName": "version",
            "AttributeType": "N"
          }
        ],
        "KeySchema": [
          {
            "AttributeName": "routename",
            "KeyType": "HASH"
          },
          {
            "AttributeName": "version",
            "KeyType": "RANGE"
          }
        ],
        "ProvisionedThroughput": {
          "ReadCapacityUnits": 1,
          "WriteCapacityUnits": 1
        }
      }
    },
    "DBResponderTable": {
      "Type": "AWS::DynamoDB::Table",
      "Properties": {
        "TableName": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "CDSGroupName"
              },
              "-cds-responder"
            ]
          ]
        },
        "AttributeDefinitions": [
          {
            "AttributeName": "queue-arn",
            "AttributeType": "S"
          }
        ],
        "KeySchema": [
          {
            "AttributeName": "queue-arn",
            "KeyType": "HASH"
          }
        ],
        "ProvisionedThroughput": {
          "ReadCapacityUnits": 1,
          "WriteCapacityUnits": 1
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "b7c9f195-625c-4a86-b3d1-5d0985f019cd"
        }
      }
    },
    "CWA2VMP8": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "ActionsEnabled": true,
        "AlarmActions": [
          {
            "Ref": "ScalingUpPolicy"
          }
        ],
        "ComparisonOperator": "GreaterThanThreshold",
        "MetricName": "ApproximateNumberOfMessagesVisible",
        "Namespace": "AWS/SQS",
        "EvaluationPeriods": "3",
        "Period": "60",
        "Statistic": "Average",
        "Threshold": {
          "Ref": "ScaleUpThreshold"
        },
        "Dimensions": [
          {
            "Name": "QueueName",
            "Value": {
              "Ref": "TestInputQueue"
            }
          }
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "0d9269e0-0451-484d-b302-0cced8d127d8"
        }
      }
    },
    "ScalingDownPolicy": {
      "Type": "AWS::AutoScaling::ScalingPolicy",
      "Properties": {
        "AdjustmentType": "ChangeInCapacity",
        "AutoScalingGroupName": {
          "Ref": "ASASG2FTUE"
        },
        "PolicyType": "SimpleScaling",
        "ScalingAdjustment": -1
	  },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "fd56009d-d1ab-409c-8759-8b6c2a0be0c7"
        }
      }
    },
    "ScalingUpPolicy": {
      "Type": "AWS::AutoScaling::ScalingPolicy",
      "Properties": {
        "AdjustmentType": "ChangeInCapacity",
        "AutoScalingGroupName": {
          "Ref": "ASASG2FTUE"
        },
        "PolicyType": "SimpleScaling",
        "ScalingAdjustment": 1
      }
    }
  }
}