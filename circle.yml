machine:
  node:
    version: 6.4.0
  ruby:
    version: ruby-2.2.5
  java:
    version: oraclejdk8

checkout:
  post:
    - chmod a+x ./circle_setup_rvm.sh
    - sudo -E ./circle_setup_rvm.sh
#    - curl -L https://install.perlbrew.pl | sudo bash
#    - echo "source ~/perl5/perlbrew/etc/bashrc" >> ~/.bash_profile
#    - source ~/perl5/perlbrew/etc/bashrc
#    - perlbrew init
#    - perlbrew install perl-5.16.0
#    - perlbrew switch perl-5.16.0

dependencies:
  override:
    #json is a listed dependency of aws-sdk
    - gem install webrick aws-sdk-v1 rspec trollop
    - sudo -i /home/ubuntu/content_delivery_system/CDS/install.sh -y
    - cd CDS/scripts/js_utils; npm install

  cache_directories:
    - "~/.sbt"
    - "~/.ivy2"
    - CDS/scripts/js_utils/node_modules
    - "~/perl5"
#    - /usr/local/lib/perl/5.18.2
#    - /usr/local/share/perl/5.18.2
#    - /usr/lib/perl5
#    - /usr/share/perl5
#    - /usr/lib/perl/5.18
#    - /usr/share/perl/5.18
#    - /usr/local/lib/site_perl
    - /opt/circleci/.rvm/gems/ruby-2.2.5

test:
  override:
    - bash ./tests/runtests.sh
    - cd CDS/cdsresponder; rspec -P test/*Spec.rb
    - cd CDS/scripts/js_utils; npm test

deployment:
  riffraff_upload:
    branch: /.*/
    commands:
      - cd CDS/cdsresponder; gem build cdsresponder.gemspec
      - sbt riffRaffUpload
